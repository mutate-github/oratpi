#!/bin/bash
set -f

CLIENT="$1"
BASEDIR=$(dirname $0)
CONFIG="mon.ini"
if [ -n "$CLIENT" ]; then
  shift
  CONFIG=${CONFIG}.${CLIENT}
  if [ ! -s "$BASEDIR/$CONFIG" ]; then echo "Exiting... Config not found: "$CONFIG ; exit 128; fi
fi
echo "Using config: ${CONFIG}"

LOGDIR="$BASEDIR/../log"
if [ ! -d "$LOGDIR" ]; then mkdir -p "$LOGDIR"; fi
HOSTS=$($BASEDIR/iniget.sh $CONFIG servers host)
SSHCMD=$($BASEDIR/iniget.sh $CONFIG others SSHCMD)
SCRIPT_NAME=$(basename $0)

CMD_MSG=(
"ps -ef | grep -v grep | grep -c proton.me"?"found EXPLOIT process proton.me on "
"ps -ef | grep -v grep | grep -c Cli"?"found EXPLOIT process Cli on "
"grep -c km.inc /etc/crontab"?"found km.inc EXPLOIT in /etc/crontab on "
"crontab -l | awk -F: '/^[^#]/ { print \$1 }' | grep -c random"?"found CRON_EXPLOIT under oracle on "
"grep -c PRNG ~/.profile 2>/dev/null"?"found EXPLOIT PRNG in ~/.profile on "
"grep -c PRNG ~/.bash_profile"?"found EXPLOIT PRNG in ~/.bash_profile on "
"grep -c PRNG ~/.bashrc"?"found EXPLOIT PRNG in ~/.bashrc on "
"ps -eo pid,args | grep -c [ex]worker"?"found [ex]worker processes on "
)


send_msg()
{
  MSG="$@"
  echo $MSG | $BASEDIR/send_msg.sh $CONFIG $0 $HOST NULL $MSG
}

# check local server
for i in "${!CMD_MSG[@]}"; do
  CMD=$(awk -F? '{print $1}' <<< ${CMD_MSG[i]})
  MSG=$(awk -F? '{print $2}' <<< ${CMD_MSG[i]})
  if [[ "$(eval $CMD)" -ne 0 ]]; then 
    send_msg $MSG $(hostname)
  fi
done

# check remote servers
for HOST in $(xargs -n1 echo <<< "$HOSTS"); do
  echo "HOST: "$HOST
  for i in "${!CMD_MSG[@]}"; do
    TRG_FILE="$LOGDIR/${SCRIPT_NAME}_${HOST}_${i}.trg"
    CMD=$(awk -F? '{print $1}' <<< ${CMD_MSG[i]})
    MSG=$(awk -F? '{print $2}' <<< ${CMD_MSG[i]})
    if [[ "$(eval $SSHCMD $HOST $CMD)" -ne 0 ]]; then
      if [[ ! -f $TRG_FILE ]]; then
        touch $TRG_FILE
        send_msg "TRIGGER: "$MSG $HOST
      else
        echo "$TRG_FILE is exists."
        REPEAT_AT=$($BASEDIR/iniget.sh $CONFIG mail repeat_at)
        HH=$(date +%H)
        case "$HH" in
          "${REPEAT_AT}")
             REPEAT_MINUTES=$($BASEDIR/iniget.sh $CONFIG mail repeat_minutes)
             FF=$(find "$TRG_FILE" -mmin +$REPEAT_MINUTES 2>/dev/null | wc -l)
             if [ "$FF" -eq 1 ]; then
                 send_msg "REPEAT: "$MSG $HOST
                 echo "TRIGGER REPEAT: $(date +%H:%M:%S-%d/%m/%y) $MSG REPEAT_MINUTES=${REPEAT_MINUTES} REPEAT_AT=${REPEAT_AT}   host: "${HOST}
                 touch $TRG_FILE
             fi
          ;;
        esac
      fi
    else
      if [[ -f $TRG_FILE ]]; then
        send_msg "RECOVER: "$MSG $HOST
        rm $TRG_FILE
      fi
    fi
  done
done

