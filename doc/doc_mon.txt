
Документация: Подсистема мониторинга и резервирования БД Oracle, использует TPI (Total Performance Insight) for Oracle

Мониторинг: Выделен в отдельные скрипты, мониторящие сервера, базы, в конфиге "mon.ini.any_client_name" прописываются правила резервирования, пороги\критерии мониторинга, рассылка алертов админам на почту, telegram канал, MAX мессенджер.
            Универсально работающий под ОС: Linux, IBM AIX, SunOS, Cygwin\OpenSSH - Windows. Начиная с версии oracle 9i и далее.
            Удобно использовать для небольших компаний, где нет централизованного мониторинга БД oracle. Успешно мониторит ~ 100-120 инстансов БД. 


Краткое описание:

1. Скрипты мониторига
mon_adrcial.sh   - мониторинг adrci событий
mon_alert.sh     - мониторинг алерт лога
mon_bck.sh       - мониторинг бекапов
mon_db.sh        - мониторинг БД
mon_tnslsnr.sh   - мониторинг listeners
mon_url.sh       - мониторинг url
mon_port.sh      - мониторинг доступности host:port
mon_db_files.sh  - мониторинг количества файлов БД, приближающихся к лимиту db_files
mon_disksp.sh    - мониторинг дискового пространства
mon_fra.sh       - мониторинг FRA
mon_fs.sh        - мониторинг файловых систем
mon_load.sh      - мониторинг нагрузки ОС
mon_lock.sh      - мониторинг блокировок БД
mon_pga.sh       - мониторинг PGA
mon_ping.sh      - мониторинг доступности ping
mon_reslim.sh    - мониторинг лимита ресурсов
mon_resumab.sh   - мониторинг наличия сессий в состоянии resumable
mon_ssh.sh       - мониторинг доступности сервера по ssh
mon_stb.sh       - мониторинг standby сервера
mon_stb_se.sh    - мониторинг standby сервера в oracle standard edition
mon_swap.sh      - мониторинг swap
mon_sysm_se.sh   - сбор sysmetrics в oracle standard edition (для истории)
mon_tbs.sh       - мониторинг табличных пространств
mon_forlog.sh    - мониторинг включения force logging на archivelog \ open read write базах
mon_aas.sh       - мониторинг % сессий от активных, испытывающих конкуренцию CONCUR COMMIT за последние 30 мин
mon_oratop.sh    - мониторинг IORL - IO Read single block latency за последние 30 мин

mon_all.sh       - общий скрипт, содержит в себе вызов всех или части имеющихся, запускается так:

kill_sniped.sh   - скрипт для kill sniped\zombie сессий

./mon_all.sh my_client_name

где "my_client_name" - это расширение конфига "mon.ini.any_client_name" из пункта 4.



также есть скрипты для отправки через gmail, yandex, свой корпоративный relay соответственно, авторизация прописывается в самих скриптах:
tgmail
tyandex
mmail   - используется perl модуль Mail::Sender, который тоже присутствует в сборке (пропишите путь до него в переменной окружения PERL5LIB)
export PERL5LIB=/home/oracle/start/tpi:$PERL5LIB

Путь до скриптов тоже необходимо прописать в PATH.

2. Скрипты резервирования БД

bck_db.sh        - резервирование БД от версии 10g и выше
bck_logs.sh      - резервирование архивных логов от версии 10g и выше

bck_db_se.sh     - резервирование БД от версии 10g и выше в oracle standard edition
bck_logs_se.sh   - резервирование архивных логов от версии 10g и выше в oracle standard edition

bck_db9i.sh      - резервирование БД версии 9i
bck_logs9i.sh    - резервирование архивных логов версии 9i


3. set_env - Конфиг установки окружения (профайла) .bash_profile .profile .ora_env  и т.п.
На серверах oracle, каждый админ настраивает переменные окружения как ему удобно. Поэтому мы для баз данных конфигурируем общий файл-конфиг профилей set_env, который использует один параметр "$sid"

его содержимое, следует по аналогии сконфигурировать под свои профили для ваших серверов:

$ cat set_env
shopt -s nocasematch
case "$sid" in
cft*|kik*|bd*|prov*)        [ -r ~/db12kik.env ] && source ~/db12kik.env ;;
jet|ja)                     [ -r /etc/profile.ora ] && source /etc/profile.ora ;;
aisutf*|unit*|crm)          [ -r ~/.ora_env ] && source ~/.ora_env ;;
egais*|GOLD506*)            [ -r ~/.bashrc ] && source ~/.bashrc ;;
unc*|UKVDEV)                [ -r ~/${sid}_setenv.sh ] && source ~/${sid}_setenv.sh ;;
orcl)                       [ -r ~/orcl_setenv.sh ] && source ~/orcl_setenv.sh ; login_str="user/passwd@'(DESCRIPTION=(ADDRESS=(COMMUNITY=TCP.WORLD)(PROTOCOL=TCP)(HOST=172.16.114.26)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=orcl)))'" ;;
dbprod|dbprog)              : ;;
hathi|PHXPRODLIKE)          [ -r ~/hathi.env ] && source ~/hathi.env ;;
*) case $(uname | awk -F_ '{print $1}') in
      Linux)  [ -r ~/.bash_profile ] && source ~/.bash_profile
              rc=$(find . -maxdepth 1 -name "${sid}_setenv.sh" -print -quit)
              if [ -n "$rc" ]; then . ~/${sid}_setenv.sh ; fi
              ;;
      AIX)    [ -r ~/.profile ] && source ~/.profile
              [ -r ~/.bashrc ] && source ~/.bashrc
              ;;
      SunOS)  [ -r ~/.profile ] && source ~/.profile
              sidlow=$(tr '[:upper:]' '[:lower:]' <<< $sid)
              [ -f /adm/env.${sidlow} ] && source /adm/env.${sidlow}
              ;;
      *)      ;;
   esac
;;
esac



4. Конфиг скриптов мониторинга
mon.ini.any_client_name

$ cat  mon.ini
[servers]
host=mp
host=md
host=mu

[mp]
# sshuser=-o User=tal
# sudo=sudo -u oracle 2>/dev/null
db=mprd
url=https://localhost:8442/ords

[md]
# sshuser=-o User=tal
# sudo=sudo -u oracle 2>/dev/null
db=mdev

[mu]
# sshuser=-o User=tal
# sudo=sudo -u oracle 2>/dev/null
db=muat

[exclude]
host:db:script=mu:%:mon_swap.sh:mon_tbs.sh

[mail]
#script=mmail
#script=tgmail
script=tyandex
prefix=ANY_CLIENT_NAME
# % - mask send mail for all host or db or scripts. may be many lines of host:db:set
# host:db:set=%:%:%
# host:db:set=aisprod:aisutf:mon_db.sh:mon_disksp.sh:mon_ping.sh:mon_ssh.sh:mon_processes_sessions.sh:mon_tbs.sh:mon_alert.sh
host:db:set=%:%:%
# repeat TRIGGER mail if trg_file is older than "repeat_minutes"
repeat_minutes=600
# repeat TRIGGER mail at "repeat_at" hour # enables pattern lists like +(...|...)
repeat_at=08|12|16

[admins]
email=dba1@company.ru admin@company.ru support@company.ru

[telegram]
# telegram will send message with curl using this parameters:
url=https://api.telegram.org/bot23234234:AAGQY9_yM7tNy_P9fH601d2ZOAuBQXI/sendMessage
# cmd=/home/oracle/telegram-bot-bash/bin/send_message.sh
chat_id=323764811
# % - mask send telegram msg for all host or db or scripts. may be many lines of host:db:set
# host:db:set=mp:%:mon_disksp.sh:mon_db.sh:mon_tbs.sh
host:db:set=%:%:mon_disksp.sh:mon_db.sh:mon_tbs.sh
# sample
# host:db:set=oraserver1:orcl:mon_db.sh:mon_alert.sh:mon_disksp.sh:mon_fra.sh:mon_ping.sh:mon_ssh.sh:mon_processes_sessions.sh:mon_stb.sh:mon_tbs.sh

[max]
url=https://3100.api.green-api.com/v3/waInstance3008474/sendMessage/f2ec0b08e41a4d9acaa9661bb9a65e6a9186f6b3228d1a8
chat_id=-69178513145


[threshold]
PGA_USAGE_LIMIT=90
DB_FILES_USAGE_LIMIT=90
AAS_CONCUR_LIMIT=60
AAS_COMMIT_LIMIT=60
ORATOP_IORL_LIMIT=5
ORATOP_DBTM_X=3
# for resource_limit in percent %
processes=80
sessions=80
enqueue_locks=80
max_rollback_segments=80
# resumable in counts sessions
resumable=0
# in minutes
enq_locks=20
# swap in %
swap=90
# osload in %
osload=80
# FRA limit in %
FRA=70
# TBS free space limit in %
TBS_USAGE_LIMIT_PER=90
# TBS free space limin in Gb
TBS_USAGE_LIMIT_GB=7
# df free space limit in %
DISK_USAGE_LIMIT_PER=90
# df free space limin in Gb
DISK_USAGE_LIMIT_DB=10
# STANDBY limit in minutes unapplied archivelogs
STB_LAG_MINUTES=30
# STANDBY limit count unapplied archivelogs
STB_SEQ_GAP=100

[others]
SSHCMD=ssh -o ConnectTimeout=5 -o ServerAliveInterval=30 -o BatchMode=yes

[standby]
# for scripts mon_stb_se.sh bck_db_se.sh bck_logs_se.sh for standby for database:  primary_host=db:standby_host
# may be multiple standby and also Standard Edition SE
mp=mprod:mpstb

[alert]
part_of_day=24
lines=20000
exclude=ORA-01005
exclude=ORA-01422
exclude=ORA-06512
exclude=ORA-12012

# backup param where host:db:set=HOST:DB:NAS:RETENTION_POLICY:RETENTION_POLICY_NUM:CATALOG\NOCATALOG:LEVEL - 0 1 2 OR ANY OTHER for statement: "not backed up since time 'sysdate-1'"
[backup]
hours_since_lvl0=170
hours_since_lvl1=170
hours_since_arch=4
hours_since_ctrl=4
level0=Sun
level1=Wed,Fri
level2=Mon,Tue,Sat
target=/
tns_catalog=rman/rman_paaswd@rman_catalog_prod
# #backup param where host:db:set=HOST:DB:NAS:RETENTION_POLICY:RETENTION_POLICY_NUM:CATALOG\NOCATALOG:LEVEL - 0 1 2 OR ANY OTHER for statement: "not backed up since time 'sysdate-1'"
host:db:set=mu:muat:nas/backup:REDUNDANCY:1:nocatalog:0
# host:db:set=mp:mprod:nas/backup:RECOVERY_WINDOW_OF:5:catalog
host:db:set=mp:mprod:nas/backup:RECOVERY_WINDOW_OF:5:nocatalog


5. Скрипт чистки логов, трейсов и т.п. Формат запуска:
./startall_purge_traces.sh  "имя_клиента"

где "имя_клиента" - расширение конфига mon.ini."имя_клиента" 


Эта документация представляет наш инструмент как законченный продукт, с которым можно сразу начать работать. 

Для коммерческого использования, если нужна поддержка, пишите на email: mutate@mail.ru
Talgat Mukhametshin
